# =====================================================
# Tmux Configuration
# Based on TheCW (theniceboy) config
# Modified prefix: Ctrl+d
# =====================================================

# -- general
setw -g xterm-keys on
set-window-option -g xterm-keys on
set -s escape-time 0
set -sg repeat-time 300
set -s focus-events on
set -s extended-keys on
set -as terminal-features 'xterm*:extkeys'
set -g mouse on
set -sg exit-empty on
set -g detach-on-destroy off
set -g allow-passthrough on

set -q -g status-utf8 on
setw -q -g utf8 on

set -g visual-activity off
setw -g monitor-activity off
setw -g monitor-bell off

set -g history-limit 10000

# reload configuration
bind r source-file ~/.config/tmux/tmux.conf \; display '~/.config/tmux/tmux.conf sourced'

# -- prefix (MODIFIED: Changed from C-s to C-d)
unbind C-b
set -g prefix 'C-d'

# -- display
set -g base-index 1
setw -g pane-base-index 1

setw -g automatic-rename on
set -g renumber-windows on

set -g set-titles on

set -g display-panes-time 2000
set -g display-time 2000

# -- navigation

# create session
bind C-c new-session

# window management (Prefix + 单键)
bind o new-window -c "#{pane_current_path}"
bind q kill-pane
unbind ,
bind , command-prompt -p "Rename window:" "rename-window '%%'"

# window navigation (F1-F12 直达，无需 Prefix)
unbind n
unbind p
unbind 1
unbind 2
unbind 3
unbind 4
unbind 5
unbind 6
unbind 7
unbind 8
unbind 9
unbind 0
bind -r C-p previous-window
bind -r C-n next-window

bind -n F1 select-window -t 1
bind -n F2 select-window -t 2
bind -n F3 select-window -t 3
bind -n F4 select-window -t 4
bind -n F5 select-window -t 5
bind -n F6 select-window -t 6
bind -n F7 select-window -t 7
bind -n F8 select-window -t 8
bind -n F9 select-window -t 9

# F10-F12 作为高频功能键
bind -n F10 new-window -c "#{pane_current_path}"
bind -n F11 kill-pane
bind -n F12 copy-mode

# Pane splitting (using C-d prefix)
bind u split-window -vb -c "#{pane_current_path}"
bind e split-window -v -c "#{pane_current_path}"
bind n split-window -hb -c "#{pane_current_path}"
bind i split-window -h -c "#{pane_current_path}"

# Default split keys (for compatibility)
bind '"' split-window -v -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"

bind f resize-pane -Z

# pane navigation (Prefix + hjkl，无需 Alt)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# 保留方向键作为备选（带 Prefix）
bind Left select-pane -L
bind Right select-pane -R
bind Up select-pane -U
bind Down select-pane -D

bind > swap-pane -D
bind < swap-pane -U
bind | swap-pane

# pane resizing (Prefix + H/J/K/L)
bind H resize-pane -L 3
bind J resize-pane -D 3
bind K resize-pane -U 3
bind L resize-pane -R 3

# Copy mode
set -g status-keys emacs
set -g mode-keys vi

bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi h send-keys -X cursor-left
bind -T copy-mode-vi l send-keys -X cursor-right
bind -T copy-mode-vi k send-keys -X cursor-up
bind -T copy-mode-vi j send-keys -X cursor-down
bind -T copy-mode-vi e send-keys -X next-word-end
bind -T copy-mode-vi K send-keys -N 5 -X cursor-up
bind -T copy-mode-vi J send-keys -N 5 -X cursor-down
bind -T copy-mode-vi H send-keys -X start-of-line
bind -T copy-mode-vi L send-keys -X end-of-line
bind -T copy-mode-vi Y send-keys -X copy-end-of-line

# macOS clipboard integration
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"

bind b list-buffers
bind p paste-buffer

# 窗口移动 (Prefix + < >)
bind < swap-window -d -t :-1
bind > swap-window -d -t :+1

# Copy mode (Prefix + v)
bind v copy-mode

# -- toggle_syn_input (sync panes)
bind C-g if-shell '[[ $(tmux showw synchronize-panes | cut -d\  -f2) == "on" ]]' \
'setw synchronize-panes off; display "Synchronize panes OFF"' \
'setw synchronize-panes on; display "Synchronize panes ON"'

# -- theme

# panes
setw -g pane-border-status top
set -g pane-active-border-style fg=#b294bb
set -g pane-border-style fg=colour244
set -g pane-border-format ' #{?pane_active,#[bold],} #P: #{pane_current_command} #{?window_zoomed_flag,⛶ ,}'

# windows
set -g status-justify 'left'
set -g status-left-length 90
set -g status-right-length 140
setw -g window-status-separator ''

# default statusbar colors
set -g status-bg black
set -g status-fg white

setw -g window-status-format '#[fg=#c5c8c6] #I:#W '
setw -g window-status-current-format '#[fg=#b294bb,bold] #I:#W '
setw -g window-status-activity-style bg=black
setw -g window-status-bell-style bg=black

set-option -g status-left '#[fg=#b294bb,bold] #S #[default]'
set-option -g status-right '#[fg=colour244] %Y-%m-%d %H:%M #[fg=#b294bb]%H:%M#[default] '

# True color support
set -g default-terminal "tmux-256color"
set -as terminal-features ",*256col*:RGB"
set -as terminal-overrides ",*256col*:Tc"

# Better scrolling in copy mode
unbind -T copy-mode-vi C-u
unbind -T copy-mode-vi C-d
bind -T copy-mode-vi C-u send-keys -N 5 -X scroll-up
bind -T copy-mode-vi C-d send-keys -N 5 -X scroll-down

# Session management
bind d detach-client
bind D choose-client

# Quick layout switch
bind Space next-layout

# Kill session
bind X confirm-before -p "Kill session #S? (y/n)" kill-session

# Reload config quickly
bind R source-file ~/.config/tmux/tmux.conf \; display "Config reloaded!"

# ─── Plugins (TPM) ───────────────────────────────────────────────
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# Resurrect: save pane contents
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-save 'S'
set -g @resurrect-restore 'R'

# Continuum: auto-save every 5 minutes
set -g @continuum-save-interval '5'
set -g @continuum-restore 'on'

# Initialize TPM (keep at very bottom)
run '~/.tmux/plugins/tpm/tpm'
